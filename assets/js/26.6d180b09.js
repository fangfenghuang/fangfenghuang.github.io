(window.webpackJsonp=window.webpackJsonp||[]).push([[26],{352:function(r,a,t){"use strict";t.r(a);var o=t(0),s=Object(o.a)({},(function(){var r=this,a=r._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":r.$parent.slotKey}},[a("h2",{attrs:{id:"harbor升级数据库迁移及回滚"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#harbor升级数据库迁移及回滚"}},[r._v("#")]),r._v(" harbor升级数据库迁移及回滚")]),r._v(" "),a("h3",{attrs:{id:"harbor安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#harbor安装"}},[r._v("#")]),r._v(" harbor安装")]),r._v(" "),a("ol",[a("li",[r._v("下载docker-compose")]),r._v(" "),a("li",[r._v("下载，解压Harbor离线包")]),r._v(" "),a("li",[r._v("修改配置harbor.yml.tmpl>harbor.yml及生成证书等")]),r._v(" "),a("li",[r._v("安装并启动：./install.sh")])]),r._v(" "),a("h3",{attrs:{id:"harbor升级-大于v1-10-x到更新版本"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#harbor升级-大于v1-10-x到更新版本"}},[r._v("#")]),r._v(" harbor升级（大于v1.10.x到更新版本）")]),r._v(" "),a("p",[r._v("harbor不同阶段的升级方式不同，存在兼容性问题，有些版本无法直接跨版本升级，需要多阶段升级方式达到最终升级目的\n自harborv2起，迁移工具全部转移到了 goharbor/prepare 这个镜像中")]),r._v(" "),a("ol",[a("li",[r._v("到github下载2.4.2版本的离线包（包含镜像goharbor/prepare）")]),r._v(" "),a("li",[r._v("准备迁移工具镜像goharbor/prepare")]),r._v(" "),a("li",[r._v("停止harbor")]),r._v(" "),a("li",[r._v("备份数据库和安装目录")]),r._v(" "),a("li",[r._v("解压离线包到安装目录")]),r._v(" "),a("li",[r._v("移动旧的配置文件到新的安装目录下")]),r._v(" "),a("li",[r._v("数据迁移：docker run -it --rm -v /:/hostfs goharbor/prepare:v2.4.2 migrate -i /opt/harbor/harbor.yml\n（此更新包括数据库模式（schema）和配置文件数据）")]),r._v(" "),a("li",[r._v("安装并启动：./install.sh")])]),r._v(" "),a("h3",{attrs:{id:"harbor回滚"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#harbor回滚"}},[r._v("#")]),r._v(" harbor回滚")]),r._v(" "),a("ol",[a("li",[r._v("停止harbor")]),r._v(" "),a("li",[r._v("删除安装目录和数据库文件")]),r._v(" "),a("li",[r._v("将备份目录和备份数据库还原回安装目录和数据库目录")]),r._v(" "),a("li",[r._v("安装并启动：./install.sh")])]),r._v(" "),a("h3",{attrs:{id:"harbor数据库迁移及golang-migrate"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#harbor数据库迁移及golang-migrate"}},[r._v("#")]),r._v(" harbor数据库迁移及golang-migrate")]),r._v(" "),a("p",[r._v("数据库升级是自动完成的，用户手动执行升级配置文件的命令行工具包。此工具包与Harbor一同发布，被包含在goharbor/prepare镜像中。")]),r._v(" "),a("p",[r._v("每次启动Harbor实例时，它的数据库模式都是自动升级的，其原理为：Harbor在每次启动时都会调用第三方库 “golang-migrate”，它会检测当前数据库模式的版本，如果实例的版本比当前数据库的版本更高，则会自动升级。")]),r._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[r._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[r._v("docker")]),r._v(" run -v /:/hostfs goharbor/prepare:v2.0.0 migrate -i "),a("span",{pre:!0,attrs:{class:"token variable"}},[r._v("${harbor.yml路径}")]),r._v("\n")])]),r._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[r._v("1")]),a("br")])])])}),[],!1,null,null,null);a.default=s.exports}}]);