(window.webpackJsonp=window.webpackJsonp||[]).push([[37],{367:function(s,a,t){"use strict";t.r(a);var e=t(0),r=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"网络"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#网络"}},[s._v("#")]),s._v(" 网络")]),s._v(" "),a("p",[s._v("虚拟机连接容器网络接口的方式：")]),s._v(" "),a("ul",[a("li",[s._v("macvtap（早期默认）：创建了一个 MACVTAP 设备以直接连接到eth0设备")]),s._v(" "),a("li",[s._v("none(使用自定义网络，只创建一个 tap 设备，不创建 veth pair)")]),s._v(" "),a("li",[s._v("tcfilter(通过 tc filter 规则将插件提供的网络接口流量重定向到连接到 VM 的 tap 接口) （现在默认）")]),s._v(" "),a("li",[s._v("bridge：（已弃用）")])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Internetworking model")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Determines how the VM should be connected to the")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# the container network interface")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Options:")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#   - macvtap")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#     Used when the Container network interface can be bridged using")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#     macvtap.")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#   - none")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#     Used when customize network. Only creates a tap device. No veth pair.")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#   - tcfilter")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#     Uses tc filter rules to redirect traffic from the network interface")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#     provided by plugin to a tap interface connected to the VM.")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("internetworking_model")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"tcfilter"')]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br")])]),a("p",[s._v("TC-filter 是默认设置，因为它允许更简单的配置、更好的 CNI 插件兼容性以及与 MACVTAP 相当的性能。")]),s._v(" "),a("ul",[a("li",[s._v("eth0属于veth-pair类型接口，一端接入cni创建的网络命名空间，一端接入宿主机")]),s._v(" "),a("li",[s._v("tap0_kata属于tap类型接口，一端接入cni创建的网络命名空间，一端接入qemu创建的hypervisor")]),s._v(" "),a("li",[s._v("使用tc策略打通eth0网络接口和tap0_kata网络接口")])]),s._v(" "),a("p",[s._v("Sandbox环境中只有eth0网络接口，这个接口是qemu和tap模拟出的接口，mac、ip、掩码都和宿主机中cni创建的网络命名空间中eth0的配置一样")]),s._v(" "),a("p",[s._v("Container运行在Sandbox环境中，Container采用共享宿主机网络命名空间方式创建容器，所以在container中看到的网络配置和Sandbox一样")]),s._v(" "),a("h2",{attrs:{id:"网络流量走向"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#网络流量走向"}},[s._v("#")]),s._v(" 网络流量走向：")]),s._v(" "),a("p",[s._v("​\t\t流量进入宿主机后首先由物理网络通过veth pair接入到net namespace，net namespace中在使用TC filter 规则流量到tap网络接口，然后再通过tap网络接口把流量送入虚拟化环境中，最后虚拟化环境中的容器共享宿主机网络命名空间后就可以在容器中拿到网络流量")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@rqy-k8s-1 hff"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ip netns exec cni-c1dea1e8-5df7-f16e-4810-e51d8895ca20 ip a")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(": lo: "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("LOOPBACK,UP,LOWER_UP"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" mtu "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("65536")]),s._v(" qdisc noqueue state UNKNOWN group default qlen "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v("\n link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n inet "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1/8 scope "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("host")]),s._v(" lo\n valid_lft forever preferred_lft forever\n inet6 ::1/128 scope "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("host")]),s._v("\n valid_lft forever preferred_lft forever\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(": tunl0@NONE: "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("NOARP"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" mtu "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1480")]),s._v(" qdisc noop state DOWN group default qlen "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v("\n link/ipip "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0 brd "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(": eth0@if113: "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("BROADCAST,MULTICAST,UP,LOWER_UP"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" mtu "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1440")]),s._v(" qdisc noqueue state UP group default qlen "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v("\n link/ether de:95:a9:f2:89:db brd ff:ff:ff:ff:ff:ff link-netnsid "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n inet "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.192")]),s._v(".181.55/32 scope global eth0\n valid_lft forever preferred_lft forever\n inet6 fe80::dc95:a9ff:fef2:89db/64 scope "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v("\n valid_lft forever preferred_lft forever\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(": tap0_kata: "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("BROADCAST,MULTICAST,UP,LOWER_UP"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" mtu "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1440")]),s._v(" qdisc mq state UNKNOWN group default qlen "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v("\n link/ether ee:32:c5:ac:30:06 brd ff:ff:ff:ff:ff:ff\n inet6 fe80::ec32:c5ff:feac:3006/64 scope "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v("\n valid_lft forever preferred_lft forever\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@rqy-k8s-1 hff"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ip netns exec cni-c1dea1e8-5df7-f16e-4810-e51d8895ca20 tc -s qdisc")]),s._v("\nqdisc noqueue "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": dev lo root refcnt "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n Sent "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" bytes "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" pkt "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("dropped "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(", overlimits "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" requeues "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n backlog 0b 0p requeues "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nqdisc noqueue "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": dev eth0 root refcnt "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n Sent "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" bytes "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" pkt "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("dropped "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(", overlimits "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" requeues "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n backlog 0b 0p requeues "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nqdisc ingress ffff: dev eth0 parent ffff:fff1 ----------------\n Sent "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("468")]),s._v(" bytes "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v(" pkt "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("dropped "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(", overlimits "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" requeues "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n backlog 0b 0p requeues "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nqdisc mq "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": dev tap0_kata root\n Sent "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1222")]),s._v(" bytes "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(" pkt "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("dropped "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(", overlimits "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" requeues "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n backlog 0b 0p requeues "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nqdisc pfifo_fast "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": dev tap0_kata parent :1 bands "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" priomap  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n Sent "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1222")]),s._v(" bytes "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(" pkt "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("dropped "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(", overlimits "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" requeues "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n backlog 0b 0p requeues "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nqdisc ingress ffff: dev tap0_kata parent ffff:fff1 ----------------\n Sent "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("936")]),s._v(" bytes "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(" pkt "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("dropped "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(", overlimits "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" requeues "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n backlog 0b 0p requeues "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@rqy-k8s-1 kbuser"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl exec -it hostpath-kata-57477fb8f7-ls6mq sh")]),s._v("\n/ "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ip addr")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(": lo: "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("LOOPBACK,UP,LOWER_UP"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" mtu "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("65536")]),s._v(" qdisc noqueue qlen "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v("\n link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n inet "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1/8 scope "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("host")]),s._v(" lo\n valid_lft forever preferred_lft forever\n inet6 ::1/128 scope "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("host")]),s._v("\n valid_lft forever preferred_lft forever\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(": eth0: "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("BROADCAST,MULTICAST,UP,LOWER_UP"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" mtu "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1440")]),s._v(" qdisc fq qlen "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v("\n link/ether de:95:a9:f2:89:db brd ff:ff:ff:ff:ff:ff\n inet "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.192")]),s._v(".181.55/32 brd "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.192")]),s._v(".181.55 scope global eth0\n valid_lft forever preferred_lft forever\n inet6 fe80::dc95:a9ff:fef2:89db/64 scope "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("link")]),s._v("\n valid_lft forever preferred_lft forever\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br")])]),a("blockquote",[a("p",[s._v("calico网络模型网络流向：\n-容器流量通过veth pair到达宿主机的网络命名空间上。\n-根据容器要访问的IP所在的子网CIDR和主机上的路由规则，找到下一跳要到达的宿主机IP。\n-流量到达下一跳的宿主机后，根据当前宿主机上的路由规则，直接到达对端容器的veth pair插在宿主机的一端，最终进入容器。")])]),s._v(" "),a("h1",{attrs:{id:"存储"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#存储"}},[s._v("#")]),s._v(" 存储")]),s._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/kata-containers/kata-containers/blob/main/docs/design/architecture/storage.md",target:"_blank",rel:"noopener noreferrer"}},[s._v("storage"),a("OutboundLink")],1)]),s._v(" "),a("ul",[a("li",[s._v("virtio SCSI（在基于块的图形驱动程序下使用）")]),s._v(" "),a("li",[s._v("virtio FS（默认）")]),s._v(" "),a("li",[s._v("Devicemapper（块设备）")])]),s._v(" "),a("p",[s._v("从 Kata Containers 的 2.0 版本开始，virtio-fs是默认的文件系统共享机制（后端是virtiofsd守护进程）。")]),s._v(" "),a("h2",{attrs:{id:"virtio-9p-和-virtio-fs-文件系统对比"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#virtio-9p-和-virtio-fs-文件系统对比"}},[s._v("#")]),s._v(" virtio-9p 和 virtio-fs 文件系统对比")]),s._v(" "),a("ol",[a("li",[s._v("virtio-9p 没有针对虚拟化场景提供优化")]),s._v(" "),a("li",[s._v("virtio-fs 利用了 hypervisor 和虚拟机处于相同节点的优势")]),s._v(" "),a("li",[s._v("DAX 特性，文件内容映射到宿主机的内存窗口，客户机直接访问宿主机的 page cache\n"),a("ul",[a("li",[s._v("减少内存占用，因为客户机 cache 已经被绕过了")])])]),s._v(" "),a("li",[s._v("相比 virtio-9p，virtio-fs 具有更好的 POSIX 合规性")])]),s._v(" "),a("h2",{attrs:{id:"virtiofs"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#virtiofs"}},[s._v("#")]),s._v(" virtiofs")]),s._v(" "),a("ul",[a("li",[s._v("所有数据都要经过virtiofs，不管是镜像数据还是⽹络存储卷。虚拟机要和宿主机数据 交互，就必须要穿过qemu，virtiofs就是穿过qemu的桥梁，提供共享⽂件机制。")]),s._v(" "),a("li",[s._v("guest和host数据传输都是通过virtio-fs，包括容器镜像和容器卷，读写权限取决于virtiofsd进程的权限。")]),s._v(" "),a("li",[s._v("数据相关的操作最终还是在宿主机上，⽐如镜像层的合并，仍然是containerd的存储层插件snapshotter完成，底层仍然是调⽤了overlayfs⽂件系统")])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@localhost hff"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ps -ef | grep 55e043c4c5eacba28c8d97a2aa96f76f153c5f9e49a1ad51f1031237002cf774")]),s._v("\nroot     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("28330")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":49 ?        00:00:00 /opt/kata/bin/containerd-shim-kata-v2 -namespace k8s.io -address /run/containerd/containerd.sock -publish-binary /usr/bin/containerd -id 55e043c4c5eacba28c8d97a2aa96f76f153c5f9e49a1ad51f1031237002cf774\nroot     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("28342")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("28330")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":49 ?        00:00:00 /opt/kata/libexec/kata-qemu/virtiofsd --syslog -o "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("cache")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("auto -o no_posix_lock -o "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("source")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/run/kata-containers/shared/sandboxes/55e043c4c5eacba28c8d97a2aa96f76f153c5f9e49a1ad51f1031237002cf774/shared --fd"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" -f --thread-pool-size"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" -o announce_submounts\nroot     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("28348")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":49 ?        00:00:00 /opt/kata/bin/qemu-system-x86_64 -name sandbox-55e043c4c5eacba28c8d97a2aa96f76f153c5f9e49a1ad51f1031237002cf774 -uuid 27f404fa-1887-4529-bbbb-df1525845c98 -machine q35,accel"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("kvm,kernel_irqchip"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("on,nvdimm"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("on -cpu host,pmu"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("off -qmp unix:/run/vc/vm/55e043c4c5eacba28c8d97a2aa96f76f153c5f9e49a1ad51f1031237002cf774/qmp.sock,server"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("on,wait"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("off -m 2048M,slots"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(",maxmem"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("8773M -device pci-bridge,bus"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("pcie.0,id"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("pci-bridge-0,chassis_nr"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(",shpc"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("off,addr"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(",io-reserve"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("4k,mem-reserve"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("1m,pref64-reserve"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("1m -device virtio-serial-pci,disable-modern"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("false,id"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("serial0 -device virtconsole,chardev"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("charconsole0,id"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("console0 -chardev socket,id"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("charconsole0,path"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/run/vc/vm/55e043c4c5eacba28c8d97a2aa96f76f153c5f9e49a1ad51f1031237002cf774/console.sock,server"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("on,wait"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("off -device nvdimm,id"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("nv0,memdev"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("mem0,unarmed"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("on -object memory-backend-file,id"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("mem0,mem-path"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/opt/kata/share/kata-containers/kata-clearlinux-latest.image,size"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("134217728")]),s._v(",readonly"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("on -device virtio-scsi-pci,id"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("scsi0,disable-modern"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("false -object rng-random,id"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("rng0,filename"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/dev/urandom -device virtio-rng-pci,rng"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("rng0 -device vhost-vsock-pci,disable-modern"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("false,vhostfd"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(",id"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("vsock-3099871275,guest-cid"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3099871275")]),s._v(" -chardev socket,id"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("char-3352582b4396a8ee,path"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/run/vc/vm/55e043c4c5eacba28c8d97a2aa96f76f153c5f9e49a1ad51f1031237002cf774/vhost-fs.sock -device vhost-user-fs-pci,chardev"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("char-3352582b4396a8ee,tag"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("kataShared -netdev tap,id"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("network-0,vhost"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("on,vhostfds"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(",fds"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" -device "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("driver")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("virtio-net-pci,netdev"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("network-0,mac"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("7e:c7:e5:c6:8c:d7,disable-modern"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("false,mq"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("on,vectors"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" -rtc "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("base")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("utc,driftfix"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("slew,clock"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("host -global kvm-pit.lost_tick_policy"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("discard -vga none -no-user-config -nodefaults -nographic --no-reboot -daemonize -object memory-backend-file,id"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("dimm1,size"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("2048M,mem-path"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/dev/shm,share"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("on -numa node,memdev"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("dimm1 -kernel /opt/kata/share/kata-containers/vmlinux-5.15.26-90 -append "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("tsc")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("reliable no_timer_check rcupdate.rcu_expedited"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" i8042.direct"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" i8042.dumbkbd"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" i8042.nopnp"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" i8042.noaux"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" noreplace-smp "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("reboot")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("k "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("console")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("hvc0 "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("console")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("hvc1 cryptomgr.notests net.ifnames"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("pci")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("lastbus"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("root")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/dev/pmem0p1 "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("rootflags")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("dax,data"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ordered,errors"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("remount-ro ro "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("rootfstype")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ext4 quiet systemd.show_status"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("false "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("panic")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("nr_cpus")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v(" systemd.unit"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("kata-containers.target systemd.mask"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("systemd-networkd.service systemd.mask"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("systemd-networkd.socket scsi_mod.scan"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("none -pidfile /run/vc/vm/55e043c4c5eacba28c8d97a2aa96f76f153c5f9e49a1ad51f1031237002cf774/pid -smp "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(",cores"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(",threads"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(",sockets"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v(",maxcpus"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("\nroot     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("28355")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("28342")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(":49 ?        00:00:00 /opt/kata/libexec/kata-qemu/virtiofsd --syslog -o "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("cache")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("auto -o no_posix_lock -o "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("source")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/run/kata-containers/shared/sandboxes/55e043c4c5eacba28c8d97a2aa96f76f153c5f9e49a1ad51f1031237002cf774/shared --fd"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" -f --thread-pool-size"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" -o announce_submounts\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("每⼀个 virtiofsd进程的fd参数都等于3，因为⽂件描述符是进程独⽴的，STDIO占 据了0，1和2，那么virtiofsd第⼀个可⽤的fd num就是3了")]),s._v(" "),a("h1",{attrs:{id:"存储配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#存储配置"}},[s._v("#")]),s._v(" 存储配置")]),s._v(" "),a("h2",{attrs:{id:"存储路径"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#存储路径"}},[s._v("#")]),s._v(" 存储路径：")]),s._v(" "),a("p",[s._v("/run/kata-containers/shared/sandboxes/\n/run/vc/vm/\n/run/vc/sbs/")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@localhost ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# find / -name hfftest0413-etc")]),s._v("\n/run/kata-containers/shared/sandboxes/3b54b3b02fc7f6905d01aedfc4eb209cfb11fd9136006ed6e11e1e26c0f48562/mounts/c7c33d3c7666933c6f1c182bb49bf850c5ca99f08b4595b0f37e6f817bb52768/rootfs/etc/hfftest0413-etc\n/run/kata-containers/shared/sandboxes/3b54b3b02fc7f6905d01aedfc4eb209cfb11fd9136006ed6e11e1e26c0f48562/shared/c7c33d3c7666933c6f1c182bb49bf850c5ca99f08b4595b0f37e6f817bb52768/rootfs/etc/hfftest0413-etc\n/run/containerd/io.containerd.runtime.v2.task/k8s.io/c7c33d3c7666933c6f1c182bb49bf850c5ca99f08b4595b0f37e6f817bb52768/rootfs/etc/hfftest0413-etc\n/var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/199015/fs/etc/hfftest0413-etc\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("h3",{attrs:{id:"virtiofsd-cache"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#virtiofsd-cache"}},[s._v("#")]),s._v(" virtiofsd cache")]),s._v(" "),a("p",[s._v("guest 生成时会指定内存大小，virtiofsd 会共享使用 guest 的内存。默认使用memory-backend-file 内存对象。")]),s._v(" "),a("p",[s._v("guest 和 host 数据传输都是通过 virtio-fs，包括容器镜像和容器卷，读写权限取决于 virtiofsd 进程的权限。")]),s._v(" "),a("h3",{attrs:{id:"dax-直接访问"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#dax-直接访问"}},[s._v("#")]),s._v(" DAX(直接访问)")]),s._v(" "),a("p",[s._v("DAX windows 是一块虚拟内存区域，通过 PCI Bar 把文件映射到 guest 里面，并不真正的占用主机那么多内存，即使有 100 个虚拟机，设置的 DAX cache 是 1G，也不会真的使用 100G 内存。")]),s._v(" "),a("p",[s._v("如果没有 DAX，内存使⽤量可能会⾮常⼤，因为每个 guest都有⾃⼰的⽂件缓冲区。")]),s._v(" "),a("p",[s._v("Kata Containers 官方下载的版本默认没有支持，需要编译安装 gitlab 托管的 virtio-fs qemu 项目 qemu5.0-virtiofs-dax 分支，需要单独编译qemu?qemu5.0-virtiofs-dax????")]),s._v(" "),a("ul",[a("li",[s._v("configuration.toml 设置virtio_fs_cache_size dax window ⼤⼩")])]),s._v(" "),a("h3",{attrs:{id:"virtiofsd已知问题汇总"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#virtiofsd已知问题汇总"}},[s._v("#")]),s._v(" virtiofsd已知问题汇总")]),s._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/kata-containers/runtime/issues/2797",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://github.com/kata-containers/runtime/issues/2797"),a("OutboundLink")],1)]),s._v(" "),a("h2",{attrs:{id:"containerd的snapshotter"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#containerd的snapshotter"}},[s._v("#")]),s._v(" containerd的Snapshotter")]),s._v(" "),a("p",[s._v("Snapshot为containerd实现了Snapshotter用于管理文件系统上容器镜像的快照和容器的rootfs挂载和卸载等操作功能。 snapshotter对标Docker中的graphdriver存储驱动的设计。")]),s._v(" "),a("p",[a("a",{attrs:{href:"https://blog.mobyproject.org/where-are-containerds-graph-drivers-145fc9b7255",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://blog.mobyproject.org/where-are-containerds-graph-drivers-145fc9b7255"),a("OutboundLink")],1)]),s._v(" "),a("h1",{attrs:{id:"参考资料"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考资料"}},[s._v("#")]),s._v(" 参考资料")]),s._v(" "),a("p",[a("a",{attrs:{href:"https://blog.csdn.net/u010827484/article/details/117488338",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://blog.csdn.net/u010827484/article/details/117488338"),a("OutboundLink")],1),s._v(" "),a("a",{attrs:{href:"https://github.com/kata-containers/kata-containers/blob/main/docs/design/architecture/networking.md",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://github.com/kata-containers/kata-containers/blob/main/docs/design/architecture/networking.md"),a("OutboundLink")],1),s._v(" "),a("a",{attrs:{href:"http://miaoyq.com/kata-containers-share/",target:"_blank",rel:"noopener noreferrer"}},[s._v("http://miaoyq.com/kata-containers-share/"),a("OutboundLink")],1)])])}),[],!1,null,null,null);a.default=r.exports}}]);