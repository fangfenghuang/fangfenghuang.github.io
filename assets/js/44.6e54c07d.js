(window.webpackJsonp=window.webpackJsonp||[]).push([[44],{371:function(a,s,t){"use strict";t.r(s);var n=t(0),e=Object(n.a)({},(function(){var a=this,s=a._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("h1",{attrs:{id:"前提"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#前提"}},[a._v("#")]),a._v(" 前提")]),a._v(" "),s("ul",[s("li",[a._v("物理机已开启硬件虚拟化")]),a._v(" "),s("li",[a._v("k8s容器运行时使用containerd（推荐）")])]),a._v(" "),s("h1",{attrs:{id:"部署"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#部署"}},[a._v("#")]),a._v(" 部署")]),a._v(" "),s("ul",[s("li",[a._v("给kata节点打上label: kata-worker=true（如果不需要区分kata节点，可以把kata-deploy中的节点亲和性去掉）")]),a._v(" "),s("li",[a._v("生成configuration.toml分发到各个kata节点（所有节点）/etc/kata-containers/configuration.toml")]),a._v(" "),s("li",[a._v("创建kata资源：kata-rbac.yaml、kata-deploy.yaml，创建runtimeClass： runtimeClass.yaml")])]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("$ kubectl apply -f kata-rbac.yaml\n$ kubectl apply -f kata-deploy.yaml\n\n$ kubectl -n kube-system "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("wait")]),a._v(" --timeout"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("10m --for"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("condition"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("Ready -l "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("name")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("kata-deploy pod\n\n$ kubectl apply -f kata-runtimeClasses.yaml\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br")])]),s("ul",[s("li",[a._v("各个kata节点（所有节点）创建软链接：")])]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("ln")]),a._v(" -s /opt/kata/bin/kata-runtime /usr/bin/kata-runtime\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("ln")]),a._v(" -s /opt/kata/bin/kata-monitor /usr/bin/kata-monitor\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br")])]),s("p",[a._v("注：")]),a._v(" "),s("ul",[s("li",[a._v("需要注意的是kata-deploy重启可能会导致默认的configuration.toml文件恢复默认配置，因此使用的是优先级更高的/etc/kata-containers/configuration.toml")]),a._v(" "),s("li",[a._v("使用ctr run创建的容器默认使用的是-qemu配置（/opt/kata/share/defaults/kata-containers/configuration-qemu.toml），如果需要使用ctr run测试，请同步配置到-qemu配置，或重定向shim链接到新的文件下")])]),a._v(" "),s("h2",{attrs:{id:"部署kata-monitor"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#部署kata-monitor"}},[a._v("#")]),a._v(" 部署kata-monitor")]),a._v(" "),s("p",[a._v("详情见[[kata-monitor监控]]")]),a._v(" "),s("h3",{attrs:{id:"kata节点运行kata-monitor守护进程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#kata节点运行kata-monitor守护进程"}},[a._v("#")]),a._v(" kata节点运行kata-monitor守护进程")]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("root@localhost ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# cat /etc/systemd/system/kata-monitor.service")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("Unit"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("Description")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("kata monitor\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("Service"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("ExecStart")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("/opt/kata/bin/kata-monitor -listen-address "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0.0")]),a._v(".0.0:8090\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("Restart")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("always\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("StartLimitInterval")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("RestartSec")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("10")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("Install"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("WantedBy")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("multi-user.target\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br"),s("span",{staticClass:"line-number"},[a._v("9")]),s("br"),s("span",{staticClass:"line-number"},[a._v("10")]),s("br"),s("span",{staticClass:"line-number"},[a._v("11")]),s("br"),s("span",{staticClass:"line-number"},[a._v("12")]),s("br")])]),s("h3",{attrs:{id:"promethues增加scrape-configs"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#promethues增加scrape-configs"}},[a._v("#")]),a._v(" promethues增加scrape_configs")]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("- job_name: "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'kata'")]),a._v("\n    static_configs:\n    - targets: "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'<kata节点IP>:8090'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br")])]),s("h3",{attrs:{id:"导入-grafana-dashborad"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#导入-grafana-dashborad"}},[a._v("#")]),a._v(" 导入 Grafana dashborad")]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("$ "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("curl")]),a._v(" -XPOST -i "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v("grafana节点IP"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(":3000/api/dashboards/import "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    -u admin:admin "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n    -H "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"Content-Type: application/json"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n\t-d "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"{'),s("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[a._v('\\"')]),a._v("dashboard"),s("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[a._v('\\"')]),a._v(":"),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("curl")]),a._v(" -sL https://raw.githubusercontent.com/kata-containers/kata-containers/main/docs/how-to/data/dashboard.json "),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v('}"')]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br")])]),s("h2",{attrs:{id:"检查"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#检查"}},[a._v("#")]),a._v(" 检查：")]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("root@rqy-k8s-1 ~"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# kata-runtime check")]),a._v("\n  WARN"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("0000"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(" Not running network checks as super user      "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("arch")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("amd64 "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("name")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("kata-runtime "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("pid")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("48176")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("source")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("runtime\n  System is capable of running Kata Containers\n  System can currently create Kata Containers\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br")])]),s("h1",{attrs:{id:"卸载"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#卸载"}},[a._v("#")]),a._v(" 卸载")]),a._v(" "),s("ul",[s("li",[a._v("删除所有kata容器")]),a._v(" "),s("li",[a._v("删除kata节点软连接")]),a._v(" "),s("li",[a._v("删除kata资源：kata-rbac.yaml、kata-deploy.yaml、runtimeClass.yaml")]),a._v(" "),s("li",[a._v("删除kata节点configuration.toml文件")])]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("$ kubectl delete -f kata-deploy.yaml\n\n$ kubectl -n kube-system "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("wait")]),a._v(" --timeout"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("10m --for"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("delete -l "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("name")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("kata-deploy pod\n\n$ kubectl apply -f kata-cleanup.yaml\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# The cleanup daemon-set will run a single time, cleaning up the node-label, which makes it difficult to check in an automated fashion. This process should take, at most, 5 minutes.")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# kubectl get pod -n kube-system | grep kubelet-kata-cleanup")]),a._v("\n\n$ kubectl delete -f kata-cleanup.yaml\n$ kubectl delete -f kata-rbac.yaml\n$ kubectl delete -f kata-runtimeClasses.yaml\n\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br"),s("span",{staticClass:"line-number"},[a._v("9")]),s("br"),s("span",{staticClass:"line-number"},[a._v("10")]),s("br"),s("span",{staticClass:"line-number"},[a._v("11")]),s("br"),s("span",{staticClass:"line-number"},[a._v("12")]),s("br")])]),s("h1",{attrs:{id:"升级-todo"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#升级-todo"}},[a._v("#")]),a._v(" 升级(TODO)")])])}),[],!1,null,null,null);s.default=e.exports}}]);