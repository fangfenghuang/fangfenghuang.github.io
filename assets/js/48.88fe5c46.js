(window.webpackJsonp=window.webpackJsonp||[]).push([[48],{375:function(a,s,n){"use strict";n.r(s);var t=n(0),e=Object(t.a)({},(function(){var a=this,s=a._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("h1",{attrs:{id:"containerd配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#containerd配置"}},[a._v("#")]),a._v(" containerd配置")]),a._v(" "),s("blockquote",[s("p",[a._v("/etc/containerd/config.toml\n/etc/systemd/system/kubelet.service.d/0-containerd.conf")])]),a._v(" "),s("h2",{attrs:{id:"containerd数据路径"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#containerd数据路径"}},[a._v("#")]),a._v(" containerd数据路径")]),a._v(" "),s("blockquote",[s("p",[a._v('root = "/app/docker/containerd"\nstate = "/app/docker/run/containerd"')])]),a._v(" "),s("h2",{attrs:{id:"containerd插件数据"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#containerd插件数据"}},[a._v("#")]),a._v(" containerd插件数据")]),a._v(" "),s("blockquote",[s("p",[a._v("ctr plugin ls")])]),a._v(" "),s("h1",{attrs:{id:"kata配置configuration-toml"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#kata配置configuration-toml"}},[a._v("#")]),a._v(" kata配置configuration.toml")]),a._v(" "),s("p",[a._v("默认的配置文件位于/opt/kata/share/defaults/kata-containers/configuration.toml，如果/etc/kata-containers/configuration.toml的配置文件存在，则会替代默认的配置文件。")]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("root@rqy-k8s-1 hff"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# kata-runtime --kata-show-default-config-paths")]),a._v("\n/etc/kata-containers/configuration.toml\n/opt/kata/share/defaults/kata-containers/configuration.toml\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br")])]),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("hypervisor.qemu"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v("\nuse_vsock ：使用vsocks与agent直接通信（前提支持vsocks），默认false \n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("runtime"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v("\nenable_cpu_memory_hotplug ：使能cpu和内存热插拔，默认false\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("agent.kata"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v("\ndebug_console_enabled "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("true")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("hypervisor.qemu"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sed")]),a._v(" -i -e "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('\'s/^kernel_params = "\\(.*\\)"/kernel_params = "\\1 agent.debug_console"/g\'')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${kata_configuration_file}")]),a._v('"')]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br")])]),s("p",[a._v("修改后新容器生效")]),a._v(" "),s("h2",{attrs:{id:"注意配置文件问题"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#注意配置文件问题"}},[a._v("#")]),a._v(" 注意配置文件问题")]),a._v(" "),s("p",[a._v("https://github.com/kata-containers/kata-containers/blob/main/docs/how-to/containerd-kata.md")]),a._v(" "),s("h2",{attrs:{id:"_1-hypervisor-qemu"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-hypervisor-qemu"}},[a._v("#")]),a._v(" 1. [hypervisor.qemu]")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v('path = "/usr/bin/qemu-system-x86_64" 指定 qemu 的路径\nkernel = "/usr/share/kata-containers/vmlinuz.container" 指定启动内核路径\ninitrd = "/usr/share/kata-containers/kata-containers-initrd.img" 指定 initrd\nimage = "/usr/share/kata-containers/kata-containers-centos.img" 指定系统盘，initrd 和 image 不可以同时配置，否则会出错\nkernel_params = "" 配置-append 参数，定制虚拟机内核启动参数\nfirmware = "" 指定固件，影响 qemu 的-bios 参数\nmachine_accelerators="" virtcontainers/qemu.go 的 getQemuMachine() 进行处理，加到 machine.Options 中，最终是加到-machine 参数中\ndefault_vcpus = 1 默认 vcpu 个数\ndefault_maxvcpus = 0  默认最大 vcpu 个数，设置为 0 时实际上时 240\ndefault_bridges = 1 默认 PCI 桥个数\ndefault_memory = 2048  VM 默认内存大小\nmemory_slots = 10 内存插槽个数\ndisable_block_device_use = false 是否禁用块设备\nblock_device_driver = "virtio-scsi" 块设备驱动，可以是 virtio-scsi、virtio-blk 或 nvdimm\n#block_device_cache_set = true\n#block_device_cache_direct = true\n#block_device_cache_noflush = true  块设备是否设置 cache\nenable_iothreads = false  //enable_iothreas 当前仅针对 virtio-scsi 块设备生效\n#enable_mem_prealloc = true\n#enable_hugepages = true\n#file_mem_backend = ""  //这几个配置统一用于 kata-runtime qemu 插件启动虚拟机时的内存配置\n#enable_swap=true  //是否允许虚拟机内存 swap，以支持更大的虚拟机密度\n#enable_debug=false  //影响 guest kernel 内核启动，在 enable_debug 后，guest kernel 启动项会加上 systemd.show_status true systemd.log_level debug\n#disable_nesting_checks = true 虚拟机标志是否 nestedRun，即虚拟化嵌套\nmsize=8192 9p fs msize 选项\n#use_vsock = true 是否使用 vsock\n#hotplug_vfio_on_root_bus = true 对于 vfio 设备，会挂在到 root bus 上，否则挂载到 PCI bridge 上, 默认是 false\n#disable_vhost_net = true 禁用 vhost_net\n#entropy_source= "/dev/urandom" 指定随机数发生器，默认为/dev/urandom,kata 启动虚拟机时会给虚拟机附加一个随机数发生器\n#guest_hook_path = "/usr/share/oci/hooks" guest 钩子函数执行路径,用于 OCI\n#enable_template = true 默认为 false，enable 后新的虚拟机从模板通过虚拟机克隆方式启动，所有 VM 共享相同的初始化 kernel、initramfs 和 agent 内存\n#enable_debug = true 默认为 false，enable 后，shim 将消息发往 system log\n#enable_tracing = true 默认为 false，用于跟踪\n#diable_new_netns=true 默认为 false，enable 后，runtime 不会再为 shim 和 hypervisor 进程创建一个网络 namespace，在 enable_netmon、网络模式采用 bridged 或者 macvtap 后不能 enable 该选项\n\n\n')])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br"),s("span",{staticClass:"line-number"},[a._v("9")]),s("br"),s("span",{staticClass:"line-number"},[a._v("10")]),s("br"),s("span",{staticClass:"line-number"},[a._v("11")]),s("br"),s("span",{staticClass:"line-number"},[a._v("12")]),s("br"),s("span",{staticClass:"line-number"},[a._v("13")]),s("br"),s("span",{staticClass:"line-number"},[a._v("14")]),s("br"),s("span",{staticClass:"line-number"},[a._v("15")]),s("br"),s("span",{staticClass:"line-number"},[a._v("16")]),s("br"),s("span",{staticClass:"line-number"},[a._v("17")]),s("br"),s("span",{staticClass:"line-number"},[a._v("18")]),s("br"),s("span",{staticClass:"line-number"},[a._v("19")]),s("br"),s("span",{staticClass:"line-number"},[a._v("20")]),s("br"),s("span",{staticClass:"line-number"},[a._v("21")]),s("br"),s("span",{staticClass:"line-number"},[a._v("22")]),s("br"),s("span",{staticClass:"line-number"},[a._v("23")]),s("br"),s("span",{staticClass:"line-number"},[a._v("24")]),s("br"),s("span",{staticClass:"line-number"},[a._v("25")]),s("br"),s("span",{staticClass:"line-number"},[a._v("26")]),s("br"),s("span",{staticClass:"line-number"},[a._v("27")]),s("br"),s("span",{staticClass:"line-number"},[a._v("28")]),s("br"),s("span",{staticClass:"line-number"},[a._v("29")]),s("br"),s("span",{staticClass:"line-number"},[a._v("30")]),s("br"),s("span",{staticClass:"line-number"},[a._v("31")]),s("br"),s("span",{staticClass:"line-number"},[a._v("32")]),s("br"),s("span",{staticClass:"line-number"},[a._v("33")]),s("br"),s("span",{staticClass:"line-number"},[a._v("34")]),s("br"),s("span",{staticClass:"line-number"},[a._v("35")]),s("br"),s("span",{staticClass:"line-number"},[a._v("36")]),s("br")])]),s("h1",{attrs:{id:"crictl"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#crictl"}},[a._v("#")]),a._v(" crictl")]),a._v(" "),s("p",[a._v("crictl 默认连接到 unix:///var/run/dockershim.sock")]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("root@rqy-k8s-3 fio-iperf"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# cat /etc/crictl.yaml")]),a._v("\nruntime-endpoint: unix:///run/containerd/containerd.sock\ntimeout: "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v("\ndebug: "),s("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("false")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br")])]),s("h1",{attrs:{id:"镜像配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#镜像配置"}},[a._v("#")]),a._v(" 镜像配置：")]),a._v(" "),s("blockquote",[s("p",[a._v('[plugins."io.containerd.grpc.v1.cri".registry]')])]),a._v(" "),s("p",[s("strong",[a._v("镜像存储路径：")])]),a._v(" "),s("blockquote",[s("p",[a._v("/var/lib/containerd/io.containerd.snapshotter.v1.overlayfs/snapshots/\n原docker:\n/app/docker/overlay2")])]),a._v(" "),s("h1",{attrs:{id:"修改sanbox-虚拟机-配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#修改sanbox-虚拟机-配置"}},[a._v("#")]),a._v(" 修改sanbox(虚拟机)配置")]),a._v(" "),s("p",[a._v("https://github.com/kata-containers/kata-containers/blob/main/docs/how-to/how-to-set-sandbox-config-kata.md")]),a._v(" "),s("h2",{attrs:{id:"containerd配置-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#containerd配置-2"}},[a._v("#")]),a._v(" containerd配置：")]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("​ "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("plugins."),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"io.containerd.grpc.v1.cri"')]),a._v(".containerd.runtimes.kata"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v("\n​  runtime_type "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"io.containerd.kata.v2"')]),a._v("\n​  pod_annotations "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"io.katacontainers.*"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v("\n​  container_annotations "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"io.katacontainers.*"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br")])]),s("h2",{attrs:{id:"受限注释"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#受限注释"}},[a._v("#")]),a._v(" 受限注释：")]),a._v(" "),s("p",[a._v("一些注释是"),s("em",[a._v("受限")]),a._v("的，这意味着配置文件指定了可接受的值。目前，出于安全原因，仅管理程序注释受到限制，目的是控制 Kata Containers 运行时将代表您启动哪些二进制文件。")]),a._v(" "),s("blockquote",[s("p",[a._v("configuration.toml：\nenable_annotations = []")])]),a._v(" "),s("h1",{attrs:{id:"关于runtime-名字怎么写"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#关于runtime-名字怎么写"}},[a._v("#")]),a._v(" 关于runtime 名字怎么写？")]),a._v(" "),s("p",[a._v("http://liubin.org/kata-dev-book/src/runtime-arch.html")]),a._v(" "),s("p",[a._v("在 K8s 和 containerd 中，我们会看到很多用于设置 runtime 的地方，比如 RuntimeClass 、Pod 的 runtimeClassName 定义，以及 ctr run --runtime io.containerd.run.kata.v2 和 crictl runp -r kata ，里面都有参数指定运行时的名字。")]),a._v(" "),s("p",[a._v("Pod 的 runtimeClassName 属性会查找同名的 RuntimeClass 资源\n根据 该资源的 handler ，在 containerd 的配置文件查找相应的运行时（ [plugins.cri.containerd.runtimes.${HANDLER_NAME}] ）。\n一般情况下 containerd 配置会像这样：")]),a._v(" "),s("blockquote",[s("p",[a._v('[plugins.cri.containerd.runtimes.kata]\nruntime_type = "io.containerd.kata.v2"')])]),a._v(" "),s("ul",[s("li",[a._v("ctr 命令使用的是 containerd 配置文件中的 runtime_type 属性（ containerd 用）。")]),a._v(" "),s("li",[a._v("crictl 和 K8s（实际也是 CRI 接口） 使用的是 containerd 配置中的 HANDLER_NAME（ CRI 用）。")])]),a._v(" "),s("p",[a._v("默认情况下，containerd 会根据 runtime_type 按规则对应到具体的运行时的可执行文件名。比如 Kata Containers(io.containerd.kata.v2) 运行时最终会转换为 containerd-shim-kata-v2 命令，该命令默认安装在 /usr/local/bin/containerd-shim-kata-v2。")]),a._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v('[root@localhost ~]# cat /usr/local/bin/containerd-shim-kata-v2\n#!/usr/bin/env bash\nKATA_CONF_FILE=/opt/kata/share/defaults/kata-containers/configuration-qemu.toml /opt/kata/bin/containerd-shim-kata-v2 "$@"\n')])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br")])])])}),[],!1,null,null,null);s.default=e.exports}}]);