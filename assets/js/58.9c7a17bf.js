(window.webpackJsonp=window.webpackJsonp||[]).push([[58],{388:function(t,e,s){"use strict";s.r(e);var a=s(0),n=Object(a.a)({},(function(){var t=this,e=t._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("hr"),t._v(" "),e("p",[t._v("title: events持久化\ndate: 2022-10-9 17:56:54\npermalink: /pages/events-log/\ncategories:")]),t._v(" "),e("ul",[e("li",[t._v("技术杂谈")]),t._v(" "),e("li",[t._v("kubernetes")]),t._v(" "),e("li",[t._v("日志采集\ntags:")]),t._v(" "),e("li")]),t._v(" "),e("h2",{attrs:{id:"titletag-原创"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#titletag-原创"}},[t._v("#")]),t._v(" titleTag: 原创")]),t._v(" "),e("p",[t._v("Kubernetes的事件（Event）是一种资源对象（Resource Object），用于展示集群内发生的情况，Kubernetes系统中的各个组件会将运行时发生的各种事件上报给Kubernetes API Server。例如，调度器做了什么决定，某些Pod为什么被从节点中驱逐。可以通过kubectl get event或kubectl describe pod "),e("podname",[t._v("命令显示事件，查看Kubernetes集群中发生了哪些事件。")])],1),t._v(" "),e("p",[t._v("执行这些命令后，默认情况下只会显示最近（1小时内）发生的事件。")]),t._v(" "),e("p",[t._v("由于Kubernetes的事件是一种资源对象，因此它们存储在Kubernetes API Server的Etcd集群中。为避免磁盘空间被填满，故强制执行保留策略：在最后一次的事件发生后，删除1小时之前发生的事件。")]),t._v(" "),e("p",[t._v("默认情况下 kubectl get events 并没有按照 events 发生的顺序进行排列，所以我们往往需要为其增加 --sort-by='{.metadata.creationTimestamp}' 参数来让其输出可以按时间进行排列。")]),t._v(" "),e("p",[t._v("Kubernetes 会自动将重复的 events 进行合并")]),t._v(" "),e("h2",{attrs:{id:"开源方案"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#开源方案"}},[t._v("#")]),t._v(" 开源方案")]),t._v(" "),e("ul",[e("li",[e("p",[t._v("eventrouter\nhttps://github.com/heptiolabs/eventrouter")])]),t._v(" "),e("li",[e("p",[t._v("KubeWatch")])]),t._v(" "),e("li",[e("p",[t._v("kubernetes-event-exporter（推荐）\nhttps://github.com/opsgenie/kubernetes-event-exporter\nhttps://qiankunli.github.io/2020/04/27/kubernetes_event.html")])])]),t._v(" "),e("h3",{attrs:{id:"kubernetes-event-exporter"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#kubernetes-event-exporter"}},[t._v("#")]),t._v(" kubernetes-event-exporter")]),t._v(" "),e("p",[t._v("使用kubernetes-event-exporter将k8s的事件导出到elasticsearch日志系统中")]),t._v(" "),e("p",[t._v("00-roles.yaml\n01-config.yaml配置接收者，默认是输出到本地路径\n02-deployment.yaml")]),t._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("kubectl apply -f 00-roles.yaml\nkubectl apply -f 01-config.yaml\nkubectl apply -f 02-deployment.yaml\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br")])]),e("p",[t._v("问题：")]),t._v(" "),e("ul",[e("li",[e("p",[t._v("1.0版本前会出现超时问题")])]),t._v(" "),e("li",[e("p",[t._v("采集到ES配置未验证通过，目前通过标准输出采集")])])]),t._v(" "),e("h4",{attrs:{id:"kubernetes-event-exporter-loki"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#kubernetes-event-exporter-loki"}},[t._v("#")]),t._v(" kubernetes-event-exporter + Loki")]),t._v(" "),e("p",[t._v("Promtail 配置：")]),t._v(" "),e("div",{staticClass:"language-yaml line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("scrapeConfigs")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("job_name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" kubernetes"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("events\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("pipeline_stages")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cri")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("match")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("selector")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'{app=\"event-exporter\"}'")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stages")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("json")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("expressions")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n              "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("namespace")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" involvedObject.namespace\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("labels")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("namespace")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v("  \n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br"),e("span",{staticClass:"line-number"},[t._v("7")]),e("br"),e("span",{staticClass:"line-number"},[t._v("8")]),e("br"),e("span",{staticClass:"line-number"},[t._v("9")]),e("br"),e("span",{staticClass:"line-number"},[t._v("10")]),e("br"),e("span",{staticClass:"line-number"},[t._v("11")]),e("br"),e("span",{staticClass:"line-number"},[t._v("12")]),e("br")])]),e("h4",{attrs:{id:"kubernetes-event-exporter-fluentd"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#kubernetes-event-exporter-fluentd"}},[t._v("#")]),t._v(" kubernetes-event-exporter + fluentd:")]),t._v(" "),e("div",{staticClass:"language-yaml line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ConfigMap\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" event"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("exporter"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("cfg\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("namespace")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" monitoring\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("data")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("config.yaml")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("|")]),e("span",{pre:!0,attrs:{class:"token scalar string"}},[t._v('\n    logLevel: error\n    logFormat: json\n    route:\n      routes:\n        - match:\n            - receiver: "dump"\t\t# 与下面的name对应\n    receivers:\n      - name: "dump"\n        # stdout: {}')]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br"),e("span",{staticClass:"line-number"},[t._v("7")]),e("br"),e("span",{staticClass:"line-number"},[t._v("8")]),e("br"),e("span",{staticClass:"line-number"},[t._v("9")]),e("br"),e("span",{staticClass:"line-number"},[t._v("10")]),e("br"),e("span",{staticClass:"line-number"},[t._v("11")]),e("br"),e("span",{staticClass:"line-number"},[t._v("12")]),e("br"),e("span",{staticClass:"line-number"},[t._v("13")]),e("br"),e("span",{staticClass:"line-number"},[t._v("14")]),e("br"),e("span",{staticClass:"line-number"},[t._v("15")]),e("br"),e("span",{staticClass:"line-number"},[t._v("16")]),e("br")])])])}),[],!1,null,null,null);e.default=n.exports}}]);