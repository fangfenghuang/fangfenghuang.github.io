(window.webpackJsonp=window.webpackJsonp||[]).push([[59],{384:function(e,t,s){"use strict";s.r(t);var a=s(0),n=Object(a.a)({},(function(){var e=this,t=e._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("p",[e._v("Kubernetes的事件（Event）是一种资源对象（Resource Object），用于展示集群内发生的情况，Kubernetes系统中的各个组件会将运行时发生的各种事件上报给Kubernetes API Server。例如，调度器做了什么决定，某些Pod为什么被从节点中驱逐。可以通过kubectl get event或kubectl describe pod "),t("podname",[e._v("命令显示事件，查看Kubernetes集群中发生了哪些事件。")])],1),e._v(" "),t("p",[e._v("执行这些命令后，默认情况下只会显示最近（1小时内）发生的事件。")]),e._v(" "),t("p",[e._v("由于Kubernetes的事件是一种资源对象，因此它们存储在Kubernetes API Server的Etcd集群中。为避免磁盘空间被填满，故强制执行保留策略：在最后一次的事件发生后，删除1小时之前发生的事件。")]),e._v(" "),t("p",[e._v("默认情况下 kubectl get events 并没有按照 events 发生的顺序进行排列，所以我们往往需要为其增加 --sort-by='{.metadata.creationTimestamp}' 参数来让其输出可以按时间进行排列。")]),e._v(" "),t("p",[e._v("Kubernetes 会自动将重复的 events 进行合并")]),e._v(" "),t("h2",{attrs:{id:"开源方案"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#开源方案"}},[e._v("#")]),e._v(" 开源方案")]),e._v(" "),t("ul",[t("li",[t("p",[e._v("eventrouter\nhttps://github.com/heptiolabs/eventrouter")])]),e._v(" "),t("li",[t("p",[e._v("KubeWatch")])]),e._v(" "),t("li",[t("p",[e._v("kubernetes-event-exporter（推荐）\nhttps://github.com/opsgenie/kubernetes-event-exporter\nhttps://qiankunli.github.io/2020/04/27/kubernetes_event.html")])])]),e._v(" "),t("h3",{attrs:{id:"kubernetes-event-exporter"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#kubernetes-event-exporter"}},[e._v("#")]),e._v(" kubernetes-event-exporter")]),e._v(" "),t("p",[e._v("使用kubernetes-event-exporter将k8s的事件导出到elasticsearch日志系统中")]),e._v(" "),t("p",[e._v("00-roles.yaml\n01-config.yaml配置接收者，默认是输出到本地路径\n02-deployment.yaml")]),e._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[e._v("kubectl apply -f 00-roles.yaml\nkubectl apply -f 01-config.yaml\nkubectl apply -f 02-deployment.yaml\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br"),t("span",{staticClass:"line-number"},[e._v("2")]),t("br"),t("span",{staticClass:"line-number"},[e._v("3")]),t("br")])]),t("p",[e._v("问题：")]),e._v(" "),t("ul",[t("li",[t("p",[e._v("1.0版本前会出现超时问题")])]),e._v(" "),t("li",[t("p",[e._v("采集到ES配置未验证通过，目前通过标准输出采集")])])]),e._v(" "),t("h4",{attrs:{id:"kubernetes-event-exporter-loki"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#kubernetes-event-exporter-loki"}},[e._v("#")]),e._v(" kubernetes-event-exporter + Loki")]),e._v(" "),t("p",[e._v("Promtail 配置：")]),e._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("scrapeConfigs")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("job_name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" kubernetes"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("events\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("pipeline_stages")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("cri")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("match")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("selector")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[e._v("'{app=\"event-exporter\"}'")]),e._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("stages")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("json")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n            "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("expressions")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n              "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("namespace")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" involvedObject.namespace\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("labels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n            "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("namespace")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[e._v('""')]),e._v("  \n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br"),t("span",{staticClass:"line-number"},[e._v("2")]),t("br"),t("span",{staticClass:"line-number"},[e._v("3")]),t("br"),t("span",{staticClass:"line-number"},[e._v("4")]),t("br"),t("span",{staticClass:"line-number"},[e._v("5")]),t("br"),t("span",{staticClass:"line-number"},[e._v("6")]),t("br"),t("span",{staticClass:"line-number"},[e._v("7")]),t("br"),t("span",{staticClass:"line-number"},[e._v("8")]),t("br"),t("span",{staticClass:"line-number"},[e._v("9")]),t("br"),t("span",{staticClass:"line-number"},[e._v("10")]),t("br"),t("span",{staticClass:"line-number"},[e._v("11")]),t("br"),t("span",{staticClass:"line-number"},[e._v("12")]),t("br")])]),t("h4",{attrs:{id:"kubernetes-event-exporter-fluentd"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#kubernetes-event-exporter-fluentd"}},[e._v("#")]),e._v(" kubernetes-event-exporter + fluentd:")]),e._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" v1\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" ConfigMap\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("metadata")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" event"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("exporter"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("cfg\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("namespace")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" monitoring\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("data")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("config.yaml")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("|")]),t("span",{pre:!0,attrs:{class:"token scalar string"}},[e._v('\n    logLevel: error\n    logFormat: json\n    route:\n      routes:\n        - match:\n            - receiver: "dump"\t\t# 与下面的name对应\n    receivers:\n      - name: "dump"\n        # stdout: {}')]),e._v("\n")])]),e._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[e._v("1")]),t("br"),t("span",{staticClass:"line-number"},[e._v("2")]),t("br"),t("span",{staticClass:"line-number"},[e._v("3")]),t("br"),t("span",{staticClass:"line-number"},[e._v("4")]),t("br"),t("span",{staticClass:"line-number"},[e._v("5")]),t("br"),t("span",{staticClass:"line-number"},[e._v("6")]),t("br"),t("span",{staticClass:"line-number"},[e._v("7")]),t("br"),t("span",{staticClass:"line-number"},[e._v("8")]),t("br"),t("span",{staticClass:"line-number"},[e._v("9")]),t("br"),t("span",{staticClass:"line-number"},[e._v("10")]),t("br"),t("span",{staticClass:"line-number"},[e._v("11")]),t("br"),t("span",{staticClass:"line-number"},[e._v("12")]),t("br"),t("span",{staticClass:"line-number"},[e._v("13")]),t("br"),t("span",{staticClass:"line-number"},[e._v("14")]),t("br"),t("span",{staticClass:"line-number"},[e._v("15")]),t("br"),t("span",{staticClass:"line-number"},[e._v("16")]),t("br")])])])}),[],!1,null,null,null);t.default=n.exports}}]);